<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - Blog Reader</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Copied from Admin for Consistency */
            --primary: #0f172a;
            --primary-light: #334155;
            --accent: #3b82f6;
            --accent-hover: #2563eb;

            --bg-page: #f8fafc;
            --bg-sidebar: #0f172a;
            --bg-card: #ffffff;
            --bg-input: #f1f5f9;

            --text-main: #1e293b;
            --text-muted: #64748b;
            --text-light: #f8fafc;

            --border: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);

            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;

            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
            --sidebar-width: 280px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-page);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            overflow-x: hidden;
        }

        /* --- Icons --- */
        .icon {
            width: 20px;
            height: 20px;
            fill: none;
            stroke: currentColor;
            stroke-width: 1.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .icon-lg {
            width: 24px;
            height: 24px;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-sidebar);
            color: var(--text-light);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            display: flex;
            flex-direction: column;
            padding: 24px;
            transition: transform 0.3s ease;
            z-index: 100;
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.05);
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 40px;
            padding-bottom: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo-box {
            width: 40px;
            height: 40px;
            background: var(--accent);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }

        .sidebar-title {
            font-size: 1.25rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .nav-links {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            color: #94a3b8;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
        }

        .nav-item:hover {
            color: white;
            background: rgba(255, 255, 255, 0.05);
        }

        .nav-item.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        /* --- Main Content --- */
        .main-content {
            margin-left: var(--sidebar-width);
            flex: 1;
            padding: 40px;
            width: calc(100% - var(--sidebar-width));
        }

        /* --- Top Bar --- */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        .page-header h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-main);
            letter-spacing: -0.02em;
            margin-bottom: 4px;
        }

        .page-header p {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        .user-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-card);
            padding: 8px 16px 8px 8px;
            border-radius: 50px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }

        .user-profile:hover {
            box-shadow: var(--shadow);
            transform: translateY(-1px);
        }

        .avatar-circle {
            width: 36px;
            height: 36px;
            background: var(--primary-light);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .btn-logout {
            background: none;
            border: 1px solid var(--border);
            padding: 8px 16px;
            border-radius: 8px;
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-logout:hover {
            background: #fef2f2;
            color: var(--danger);
            border-color: #fee2e2;
        }

        /* --- Blog Grid --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .blog-card {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: all 0.2s;
        }

        .blog-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .blog-image {
            width: 100%;
            height: 200px;
            background: var(--bg-input);
            position: relative;
            overflow: hidden;
        }

        .blog-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .blog-body {
            padding: 24px;
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .category-badge {
            display: inline-block;
            font-size: 0.75rem;
            background: #eff6ff;
            color: var(--accent);
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
            margin-bottom: 12px;
            width: fit-content;
        }

        .blog-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .blog-meta {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 16px;
            display: flex;
            gap: 12px;
        }

        .read-more-btn {
            margin-top: auto;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            width: fit-content;
        }

        .read-more-btn:hover {
            background: var(--bg-input);
            border-color: var(--text-muted);
        }

        /* --- Search & Filter --- */
        .search-section {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 32px;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            /* space for icon */
            background: white;
            border: 1px solid var(--border);
            border-radius: 10px;
            box-shadow: var(--shadow-sm);
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: white;
            border: 1px solid var(--border);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-muted);
            font-weight: 500;
            transition: all 0.2s;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* --- Tables (For Tickets) --- */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            padding: 24px;
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        th {
            text-align: left;
            padding: 16px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            background: #f8fafc;
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 16px;
            font-size: 0.95rem;
            border-bottom: 1px solid var(--border);
            color: var(--text-main);
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.show {
            display: flex;
            animation: fadeUpdate 0.2s;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 32px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: var(--shadow-lg);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Animation */
        @keyframes fadeUpdate {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .section {
            display: none;
            animation: fadeUpdate 0.4s ease;
        }

        .section.active {
            display: block;
        }

        /* Mobile */
        .menu-toggle {
            display: none;
        }

        .overlay {
            display: none;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                width: 100%;
                padding: 20px;
            }

            .menu-toggle {
                display: block;
                background: none;
                border: none;
                cursor: pointer;
                color: var(--text-main);
            }

            .overlay.active {
                display: block;
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 90;
            }
        }
    </style>
</head>

<body>

    <script>
        // üîê Security Check
        const token = localStorage.getItem("token");
        const role = localStorage.getItem("role");
        if (!token) window.location.href = "../account.html";
        if (role === "admin") window.location.href = "../admin/dashboard.html";
    </script>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo-box">
                <!-- Book Icon -->
                <svg class="icon icon-lg" viewBox="0 0 24 24">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" />
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" />
                </svg>
            </div>
            <div class="sidebar-title">UserPanel</div>
        </div>
        <nav class="nav-links">
            <a class="nav-item active" onclick="switchTab('home')" id="nav-home">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
                </svg>
                <span>Read Blogs</span>
            </a>
            <a class="nav-item" onclick="switchTab('tickets')" id="nav-tickets">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M15 5v2" />
                    <path d="M15 11v2" />
                    <path d="M15 17v2" />
                    <path
                        d="M5 5h14a2 2 0 0 1 2 2v3a2 2 0 0 0 0 4v3a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-3a2 2 0 0 0 0-4V7a2 2 0 0 1 2-2z" />
                </svg>
                <span>My Tickets</span>
            </a>
            <a class="nav-item" href="../index.html">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                <span>Back to Home</span>
            </a>
        </nav>
    </aside>
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Bar -->
        <div class="top-bar">
            <div style="display: flex; align-items: center; gap: 15px;">
                <button class="menu-toggle" onclick="toggleSidebar()">
                    <svg class="icon icon-lg" viewBox="0 0 24 24">
                        <line x1="3" y1="12" x2="21" y2="12" />
                        <line x1="3" y1="6" x2="21" y2="6" />
                        <line x1="3" y1="18" x2="21" y2="18" />
                    </svg>
                </button>
                <div class="page-header">
                    <h2 id="pageTitle">Welcome</h2>
                    <p id="pageDesc">Explore the latest updates and articles.</p>
                </div>
            </div>

            <div class="user-actions">
                <div class="user-profile" onclick="openProfile()" title="View Profile">
                    <div class="avatar-circle" id="userAvatar">U</div>
                    <span style="font-weight: 500; font-size: 0.9rem;" id="navName">User</span>
                    <!-- Hidden role span for potential script refs -->
                    <span id="navRole" style="display:none;">user</span>
                </div>
                <button class="btn-logout" onclick="logout()">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                        <polyline points="16 17 21 12 16 7" />
                        <line x1="21" y1="12" x2="9" y2="12" />
                    </svg>
                    Logout
                </button>
            </div>
        </div>

        <!-- HOME SECTION (BLOGS) -->
        <div id="home-section" class="section active">
            <!-- Search & Filter -->
            <div class="search-section">
                <div class="search-box">
                    <!-- Magnifying glass inside input -->
                    <input type="text" id="searchInput" placeholder="Search articles..." onkeyup="filterBlogs()">
                </div>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterCategory('all', this)">All</button>
                    <button class="filter-btn" onclick="filterCategory('Technology', this)">Tech</button>
                    <button class="filter-btn" onclick="filterCategory('Tutorial', this)">Tutorials</button>
                    <button class="filter-btn" onclick="filterCategory('News', this)">News</button>
                </div>
            </div>

            <div id="blogGrid" class="dashboard-grid">
                <!-- Blogs Injected Here -->
            </div>

            <div id="emptyState" style="display: none; text-align: center; color: var(--text-muted); padding: 40px;">
                <h3>No blogs found</h3>
                <p>Try adjusting your search terms.</p>
            </div>
        </div>

        <!-- TICKETS SECTION -->
        <div id="tickets-section" class="section">
            <div class="card">
                <div class="card-header"
                    style="justify-content: space-between; display: flex; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 16px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div class="card-icon-box"
                            style="width: 36px; height: 36px; background: #eff6ff; color: var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                            <svg class="icon" viewBox="0 0 24 24">
                                <path d="M15 5v2" />
                                <path d="M15 11v2" />
                                <path d="M15 17v2" />
                                <path
                                    d="M5 5h14a2 2 0 0 1 2 2v3a2 2 0 0 0 0 4v3a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-3a2 2 0 0 0 0-4V7a2 2 0 0 1 2-2z" />
                            </svg>
                        </div>
                        <h2 class="card-title" style="margin:0; font-size: 1.1rem; font-weight: 600;">My Support Tickets
                        </h2>
                    </div>
                    <button class="filter-btn active" style="background: var(--accent); color: white; border: none;"
                        onclick="openTicketModal()">+ New Ticket</button>
                </div>

                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Subject</th>
                                <th>Priority</th>
                                <th>Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="ticketList">
                            <!-- Tickets Injected Here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- Ticket Modal -->
    <div class="modal-overlay" id="ticketModal">
        <div class="modal-content">
            <div class="modal-header"
                style="border-bottom: 1px solid var(--border); padding-bottom: 16px; margin-bottom: 20px; display: flex; justify-content: space-between;">
                <h3 class="modal-title" style="font-size: 1.25rem;">Create New Ticket</h3>
                <button class="btn-logout" style="border:none; padding: 4px;" onclick="closeTicketModal()">‚úï</button>
            </div>
            <div style="display: flex; flex-direction: column; gap: 16px;">
                <div>
                    <label
                        style="display: block; margin-bottom: 8px; color: var(--text-muted); font-size: 0.9rem;">Subject</label>
                    <input type="text" id="ticketSubject"
                        style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px;"
                        placeholder="Briefly describe the issue">
                </div>
                <div>
                    <label
                        style="display: block; margin-bottom: 8px; color: var(--text-muted); font-size: 0.9rem;">Priority</label>
                    <select id="ticketPriority"
                        style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px;">
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                    </select>
                </div>
                <div>
                    <label
                        style="display: block; margin-bottom: 8px; color: var(--text-muted); font-size: 0.9rem;">Message</label>
                    <textarea id="ticketMessage" rows="5"
                        style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px;"
                        placeholder="Explain in detail..."></textarea>
                </div>
                <button onclick="createTicket()"
                    style="background: var(--accent); color: white; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; justify-content: center; gap: 8px;">
                    Submit Ticket
                </button>
            </div>
        </div>
    </div>

    <!-- Blog Detail Modal -->
    <div class="modal-overlay" id="blogModal">
        <div class="modal-content" style="max-width: 800px;">
            <button onclick="closeModal()"
                style="position: absolute; right: 20px; top: 20px; background: none; border: none; cursor: pointer; color: var(--text-muted);">
                <svg class="icon" viewBox="0 0 24 24">
                    <line x1="18" y1="6" x2="6" y2="18" />
                    <line x1="6" y1="6" x2="18" y2="18" />
                </svg>
            </button>
            <div id="modalMeta"
                style="margin-bottom: 12px; display: flex; gap: 12px; color: var(--text-muted); font-size: 0.9rem;">
            </div>
            <h2 id="modalTitle" style="font-size: 1.8rem; font-weight: 700; margin-bottom: 24px;"></h2>
            <div id="modalBody" style="line-height: 1.6; color: var(--text-main);"></div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal-content">
            <div class="modal-header"
                style="margin-bottom: 24px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
                <h3 class="modal-title">My Profile</h3>
                <button class="btn-logout" style="border:none; padding: 4px;" onclick="closeProfile()">‚úï</button>
            </div>
            <div style="display: flex; flex-direction: column; gap: 16px;">
                <div>
                    <label style="color: var(--text-muted); font-size: 0.85rem;">Name</label>
                    <div id="profileName" style="font-weight: 600; font-size: 1.1rem; padding: 8px 0;">Loading...</div>
                </div>
                <div>
                    <label style="color: var(--text-muted); font-size: 0.85rem;">Email</label>
                    <div id="profileEmail" style="font-weight: 600; font-size: 1.1rem; padding: 8px 0;">Loading...</div>
                </div>
                <div>
                    <label style="color: var(--text-muted); font-size: 0.85rem;">Member Since</label>
                    <div id="profileDate" style="font-weight: 600; font-size: 1.1rem; padding: 8px 0;">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Base
        const API = "http://localhost:5000/api/blogs";
        const TICKET_API = "http://localhost:5000/api/tickets";
        const AUTH_API = "http://localhost:5000/api/auth";

        let allBlogs = [];
        let currentCategory = 'all';

        // --- AUTH ---
        async function fetchUser() {
            try {
                const res = await fetch(`${AUTH_API}/me`, { headers: { 'Authorization': 'Bearer ' + token } });
                const user = await res.json();

                // Safe DOM updates
                const navName = document.getElementById("navName");
                if (navName) navName.innerText = user.name.split(' ')[0]; // Show first name

                const userAvatar = document.getElementById("userAvatar");
                if (userAvatar) userAvatar.innerText = user.name.charAt(0).toUpperCase();

                // Profile Modal
                document.getElementById('profileName').innerText = user.name;
                document.getElementById('profileEmail').innerText = user.email;
                document.getElementById('profileDate').innerText = new Date(user.createdAt).toLocaleDateString();

            } catch (err) {
                console.error("Auth Error", err);
                if (err.status === 401) logout();
            }
        }
        fetchUser();

        function logout() { localStorage.clear(); window.location.href = "../account.html"; }

        // --- NAVIGATION ---
        function switchTab(tab) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            const target = document.getElementById(`${tab}-section`);
            if (target) target.classList.add('active');

            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const nav = document.getElementById(`nav-${tab}`);
            if (nav) nav.classList.add('active');

            // Mobile close
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');

            // Titles
            const titleEl = document.getElementById('pageTitle');
            const descEl = document.getElementById('pageDesc');

            if (tab === 'home') {
                titleEl.innerText = "Welcome";
                descEl.innerText = "Explore the latest updates and articles.";
                fetchBlogs();
            } else if (tab === 'tickets') {
                titleEl.innerText = "Support";
                descEl.innerText = "Track and manage your support requests.";
                loadTickets();
            }
        }

        // Mobile Sidebar
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
        }

        // --- BLOGS ---
        async function fetchBlogs() {
            try {
                const res = await fetch(API, { headers: { "Authorization": "Bearer " + token } });
                const blogs = await res.json();
                allBlogs = blogs;
                renderBlogs(blogs);
            } catch (error) { console.error("Error fetching blogs", error); }
        }

        function renderBlogs(blogs) {
            const grid = document.getElementById('blogGrid');
            const empty = document.getElementById('emptyState');

            if (blogs.length === 0) {
                grid.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';

            grid.innerHTML = blogs.map(blog => `
                <article class="blog-card">
                    <div class="blog-image">
                        <img src="${blog.image ? (blog.image.startsWith('http') ? blog.image : 'http://localhost:5000' + blog.image) : 'https://via.placeholder.com/400x250?text=No+Image'}" 
                             alt="${blog.title}" onerror="this.src='https://via.placeholder.com/400x250?text=No+Image'">
                    </div>
                    <div class="blog-body">
                         <span class="category-badge">${blog.category || 'General'}</span>
                         <h3 class="blog-title">${blog.title}</h3>
                         <div class="blog-meta">
                             <span>${new Date(blog.createdAt).toLocaleDateString()}</span>
                             <span>‚Ä¢ ${Math.ceil(blog.content.split(' ').length / 200)} min read</span>
                         </div>
                         <button class="read-more-btn" onclick='openBlogModal(${JSON.stringify(blog).replace(/'/g, "&#39;")})'>
                             Read Article <svg class="icon icon-sm" viewBox="0 0 24 24" style="width:16px;height:16px;"><path d="M14 5l7 7m0 0l-7 7m7-7H3"/></svg>
                         </button>
                    </div>
                </article>
            `).join('');
        }

        // Filter
        function filterCategory(cat, btn) {
            currentCategory = cat;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            applyFilters();
        }

        function filterBlogs() { applyFilters(); }

        function applyFilters() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allBlogs.filter(b => {
                const matchSearch = b.title.toLowerCase().includes(query) || b.content.toLowerCase().includes(query);
                const matchCat = currentCategory === 'all' || (b.category || 'General') === currentCategory;
                return matchSearch && matchCat;
            });
            renderBlogs(filtered);
        }

        // Blog Modal
        function openBlogModal(blog) {
            document.getElementById('modalTitle').innerText = blog.title;
            document.getElementById('modalMeta').innerHTML = `<span>${new Date(blog.createdAt).toLocaleDateString()}</span><span>‚Ä¢ ${blog.category || 'General'}</span>`;
            document.getElementById('modalBody').innerText = blog.content; // Simple text render for security
            document.getElementById('blogModal').classList.add('show');
        }
        function closeModal() { document.getElementById('blogModal').classList.remove('show'); }


        // --- TICKETS ---
        async function loadTickets() {
            const list = document.getElementById('ticketList');
            list.innerHTML = '<tr><td colspan="4" style="text-align:center;">Loading...</td></tr>';
            try {
                const res = await fetch(TICKET_API, { headers: { "Authorization": "Bearer " + token } });
                const tickets = await res.json();

                if (tickets.length === 0) {
                    list.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 30px; color: var(--text-muted);">No tickets yet. Create one to get started.</td></tr>';
                    return;
                }

                list.innerHTML = tickets.map(t => `
                    <tr>
                        <td>
                            <div style="font-weight: 600;">${t.subject}</div>
                            <div style="font-size: 0.85rem; color: var(--text-muted);">${t.message.substring(0, 40)}...</div>
                        </td>
                        <td><span style="color: ${t.priority === 'High' ? 'var(--danger)' : 'var(--warning)'}; font-weight: 600;">${t.priority}</span></td>
                        <td>${new Date(t.createdAt).toLocaleDateString()}</td>
                        <td><span style="background: ${t.status === 'Open' ? '#dbeafe' : '#f1f5f9'}; color: ${t.status === 'Open' ? '#1e40af' : '#64748b'}; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">${t.status}</span></td>
                    </tr>
                `).join('');
            } catch (e) {
                list.innerHTML = '<tr><td colspan="4" style="color:red; text-align:center;">Error loading tickets</td></tr>';
            }
        }

        function openTicketModal() { document.getElementById('ticketModal').classList.add('show'); }
        function closeTicketModal() { document.getElementById('ticketModal').classList.remove('show'); }

        async function createTicket() {
            const subject = document.getElementById('ticketSubject').value;
            const priority = document.getElementById('ticketPriority').value;
            const message = document.getElementById('ticketMessage').value;

            if (!subject || !message) return alert("Please fill all fields");

            const res = await fetch(TICKET_API, {
                method: 'POST',
                headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
                body: JSON.stringify({ subject, priority, message })
            });

            if (res.ok) {
                alert("Ticket Created");
                closeTicketModal();
                loadTickets();
                document.getElementById('ticketSubject').value = '';
                document.getElementById('ticketMessage').value = '';
            } else {
                alert("Failed to create ticket");
            }
        }

        // Profile Modal
        function openProfile() { document.getElementById('profileModal').classList.add('show'); }
        function closeProfile() { document.getElementById('profileModal').classList.remove('show'); }

        // Initial Load
        fetchBlogs();
    </script>
</body>

</html>

